{% extends "base.html" %}

{% block title %}ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª - æ•™ç§‘æ›¸ç¿»è¨³ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold text-gray-800 mb-8">ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>

    <!-- ã‚¸ãƒ§ãƒ–æƒ…å ± -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h3 class="text-xl font-bold mb-4">ã‚¸ãƒ§ãƒ–æƒ…å ±</h3>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <span class="text-sm text-gray-500">ã‚¸ãƒ§ãƒ–ID</span>
                <p class="font-mono text-sm" id="jobId">{{ job_id }}</p>
            </div>
            <div>
                <span class="text-sm text-gray-500">ãƒ•ã‚¡ã‚¤ãƒ«å</span>
                <p class="font-semibold" id="fileName">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
            <div>
                <span class="text-sm text-gray-500">ãƒšãƒ¼ã‚¸æ•°</span>
                <p class="font-semibold" id="pageCount">-</p>
            </div>
            <div>
                <span class="text-sm text-gray-500">ä½œæˆæ—¥æ™‚</span>
                <p class="text-sm" id="createdAt">-</p>
            </div>
        </div>
    </div>

    <!-- OCRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="bg-white rounded-lg shadow-md p-8 mb-6">
        <h3 class="text-xl font-bold mb-4">OCRå‡¦ç†</h3>
        <div class="flex items-center mb-4">
            <span class="text-2xl mr-3" id="ocrStatusIcon">â³</span>
            <div class="flex-1">
                <p class="font-semibold" id="ocrStatusText">å‡¦ç†ä¸­...</p>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div id="ocrProgressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="ocrResult" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <p class="text-green-800">
                <strong>OCRå®Œäº†:</strong> ãƒã‚¹ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ
            </p>
            <a href="#" id="downloadMasterBtn" class="text-blue-600 hover:underline text-sm mt-2 inline-block">
                ãƒã‚¹ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            </a>
        </div>

        <div id="ocrError" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-red-800" id="ocrErrorText"></p>
        </div>
    </div>

    <!-- ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="bg-white rounded-lg shadow-md p-8">
        <h3 class="text-xl font-bold mb-4">ç¿»è¨³å‡¦ç†</h3>

        <div id="translationsContainer">
            <p class="text-gray-500 text-center py-8">ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mt-6 flex justify-between">
        <a href="/upload" class="text-gray-600 hover:text-gray-800">
            â† æ–°ã—ã„ç¿»è¨³ã‚’é–‹å§‹
        </a>
        <button id="refreshBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
            ğŸ”„ æ›´æ–°
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const JOB_ID = "{{ job_id }}";

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
async function fetchStatus() {
    try {
        const response = await fetch(`/api/jobs/${JOB_ID}`);
        const data = await response.json();

        // ã‚¸ãƒ§ãƒ–æƒ…å ±æ›´æ–°
        document.getElementById('fileName').textContent = data.job.original_filename || '-';
        document.getElementById('pageCount').textContent = data.job.page_count || '-';
        document.getElementById('createdAt').textContent = new Date(data.job.created_at).toLocaleString('ja-JP');

        // OCRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        updateOCRStatus(data.job);

        // ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        updateTranslationStatus(data.translations);

    } catch (error) {
        console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// OCRã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateOCRStatus(job) {
    const statusIcon = document.getElementById('ocrStatusIcon');
    const statusText = document.getElementById('ocrStatusText');
    const progressBar = document.getElementById('ocrProgressBar');
    const resultDiv = document.getElementById('ocrResult');
    const errorDiv = document.getElementById('ocrError');

    switch (job.ocr_status) {
        case 'pending':
            statusIcon.textContent = 'â³';
            statusText.textContent = 'å‡¦ç†å¾…æ©Ÿä¸­...';
            progressBar.style.width = '0%';
            break;
        case 'processing':
            statusIcon.textContent = 'âš™ï¸';
            statusText.textContent = 'OCRå‡¦ç†ä¸­...';
            progressBar.style.width = '50%';
            break;
        case 'completed':
            statusIcon.textContent = 'âœ…';
            statusText.textContent = 'OCRå®Œäº†';
            progressBar.style.width = '100%';
            resultDiv.classList.remove('hidden');
            document.getElementById('downloadMasterBtn').href = `/api/download/job/${JOB_ID}/master`;
            break;
        case 'failed':
            statusIcon.textContent = 'âŒ';
            statusText.textContent = 'OCRã‚¨ãƒ©ãƒ¼';
            progressBar.style.width = '0%';
            errorDiv.classList.remove('hidden');
            document.getElementById('ocrErrorText').textContent = job.ocr_error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
            break;
    }
}

// ç¿»è¨³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
function updateTranslationStatus(translations) {
    const container = document.getElementById('translationsContainer');

    if (!translations || translations.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">ç¿»è¨³ã¯ã¾ã é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
        return;
    }

    const languageNames = {
        'en': 'è‹±èª',
        'zh': 'ä¸­å›½èªï¼ˆç°¡ä½“å­—ï¼‰',
        'zh-TW': 'ä¸­å›½èªï¼ˆç¹ä½“å­—ï¼‰',
        'ko': 'éŸ“å›½èª',
        'vi': 'ãƒ™ãƒˆãƒŠãƒ èª',
        'th': 'ã‚¿ã‚¤èª',
        'es': 'ã‚¹ãƒšã‚¤ãƒ³èª',
        'fr': 'ãƒ•ãƒ©ãƒ³ã‚¹èª'
    };

    container.innerHTML = translations.map(t => `
        <div class="border rounded-lg p-4 mb-3">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <h4 class="font-semibold">${languageNames[t.target_language] || t.target_language}</h4>
                    <p class="text-sm text-gray-600">${getStatusText(t.status)}</p>
                </div>
                <div class="flex items-center space-x-2">
                    ${getStatusIcon(t.status)}
                    ${t.status === 'completed' ? `
                        <div class="flex space-x-1">
                            <a href="/api/download/${t.id}/markdown" class="text-blue-600 hover:underline text-sm">MD</a>
                            <span class="text-gray-300">|</span>
                            <a href="/api/download/${t.id}/html" class="text-blue-600 hover:underline text-sm">HTML</a>
                            <span class="text-gray-300">|</span>
                            <a href="/api/download/${t.id}/pdf" class="text-blue-600 hover:underline text-sm">PDF</a>
                        </div>
                    ` : ''}
                </div>
            </div>
            ${t.status === 'processing' ? `
                <div class="w-full bg-gray-200 rounded-full h-1 mt-2">
                    <div class="bg-green-600 h-1 rounded-full animate-pulse" style="width: 60%"></div>
                </div>
            ` : ''}
            ${t.status === 'failed' ? `
                <p class="text-sm text-red-600 mt-2">${t.error_message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}</p>
            ` : ''}
        </div>
    `).join('');
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'å¾…æ©Ÿä¸­',
        'processing': 'ç¿»è¨³ä¸­...',
        'completed': 'å®Œäº†',
        'failed': 'ã‚¨ãƒ©ãƒ¼'
    };
    return statusMap[status] || status;
}

function getStatusIcon(status) {
    const iconMap = {
        'pending': '<span class="text-gray-400">â³</span>',
        'processing': '<span class="text-blue-500">âš™ï¸</span>',
        'completed': '<span class="text-green-500">âœ…</span>',
        'failed': '<span class="text-red-500">âŒ</span>'
    };
    return iconMap[status] || '';
}

// è‡ªå‹•æ›´æ–°ï¼ˆ5ç§’ã”ã¨ï¼‰
let intervalId = null;

function startAutoRefresh() {
    fetchStatus();
    intervalId = setInterval(fetchStatus, 5000);
}

function stopAutoRefresh() {
    if (intervalId) {
        clearInterval(intervalId);
        intervalId = null;
    }
}

// æ‰‹å‹•æ›´æ–°
document.getElementById('refreshBtn').addEventListener('click', fetchStatus);

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é–‹å§‹
startAutoRefresh();

// ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ãã«åœæ­¢
window.addEventListener('beforeunload', stopAutoRefresh);
</script>
{% endblock %}
